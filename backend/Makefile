.PHONY: help install run run-local test test-api clean migrate db-upgrade db-downgrade format lint db-create docker-up docker-down docker-status docker-db

# Default target - show help
help:
	@echo "ğŸ“‹ TrackWise Transit AI - Available Commands"
	@echo "========================================"
	@echo ""
	@echo "ğŸ³ Docker Database Commands:"
	@echo "  make docker-up     - ğŸš€ Start Docker PostgreSQL & Redis"
	@echo "  make docker-down   - ğŸ›‘ Stop Docker containers"
	@echo "  make docker-status - ğŸ“Š Check Docker containers status"
	@echo "  make docker-db     - ğŸ” Connect to Docker PostgreSQL shell"
	@echo ""
	@echo "ğŸš€ Server Commands:"
	@echo "  make run           - ğŸ³ Run server with Docker database"
	@echo "  make run-local     - ğŸ’» Run server with local database"
	@echo ""
	@echo "ğŸ”§ Setup & Database:"
	@echo "  make install       - ğŸ“¦ Set up virtual environment and install dependencies"
	@echo "  make db-create     - ğŸ—„ï¸  Create database if it doesn't exist"
	@echo "  make migrate       - ğŸ”„ Create a new database migration"
	@echo "  make db-upgrade    - â¬†ï¸  Apply database migrations"
	@echo "  make db-downgrade  - â¬‡ï¸  Rollback last migration"
	@echo ""
	@echo "ğŸ§ª Testing & Quality:"
	@echo "  make test          - ğŸ§ª Run tests with pytest"
	@echo "  make test-api      - ğŸ§ª Test all API endpoints"
	@echo "  make format        - ğŸ¨ Format code with black"
	@echo "  make lint          - ğŸ” Run linting checks"
	@echo "  make clean         - ğŸ§¹ Remove generated files and caches"
	@echo ""
	@echo "Quick start: make docker-up && make run"
	@echo ""

# Install dependencies
install:
	@echo "ğŸ“¦ Setting up virtual environment..."
	python3 -m venv .venv
	@echo "â¬†ï¸  Upgrading pip..."
	.venv/bin/pip install --upgrade pip
	@echo "ğŸ“¥ Installing dependencies..."
	.venv/bin/pip install -r requirements.txt
	@echo ""
	@echo "âœ… Installation complete!"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Copy .env.example to .env and configure"
	@echo "  2. Run 'make db-upgrade' to set up database"
	@echo "  3. Run 'make run' to start the server"
	@echo ""

# Run development server with Docker database
run:
	@echo "ğŸ³ Starting development server with Docker PostgreSQL..."
	@echo "ğŸ“š API docs will be available at: http://localhost:8000/docs"
	@echo ""
	@# Ensure we're using Docker database configuration
	@if [ -f .env.docker ]; then \
		cp .env.docker .env; \
		echo "âœ… Using Docker database configuration"; \
	fi
	@# Check if Docker PostgreSQL is running
	@if ! docker ps | grep -q trackwise_postgres; then \
		echo "âš ï¸  Docker PostgreSQL is not running!"; \
		echo "Run 'make docker-up' first"; \
		exit 1; \
	fi
	@echo "ğŸš€ Starting server..."
	DATABASE_URL="postgresql://trackwise:trackwise_dev@localhost:5432/trackwise" .venv/bin/uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Run development server with local database
run-local:
	@echo "ğŸ’» Starting development server with local PostgreSQL..."
	@echo "ğŸ“š API docs will be available at: http://localhost:8000/docs"
	@echo ""
	@# Ensure we're using local database configuration
	@if [ -f .env.local ]; then \
		cp .env.local .env; \
		echo "âœ… Using local database configuration"; \
	fi
	@echo "ğŸš€ Starting server..."
	.venv/bin/uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	.venv/bin/pytest app/tests/ -v --cov=app --cov-report=term-missing

# Test all API endpoints
test-api:
	@echo "ğŸ§ª Testing all API endpoints..."
	@echo "ğŸ“‹ Make sure the server is running: make run"
	@echo ""
	PYTHONPATH=. .venv/bin/python scripts/test_api.py

# Create database if it doesn't exist
db-create:
	@echo "ğŸ—„ï¸  Creating database if it doesn't exist..."
	PYTHONPATH=. .venv/bin/python scripts/create_db.py

# Create new migration
migrate:
	@echo "ğŸ”„ Creating new migration..."
	@read -p "Enter migration message: " message; \
	.venv/bin/alembic revision --autogenerate -m "$$message"

# Apply migrations
db-upgrade:
	@echo "â¬†ï¸  Applying database migrations..."
	.venv/bin/alembic upgrade head

# Rollback migration
db-downgrade:
	@echo "â¬‡ï¸  Rolling back last migration..."
	.venv/bin/alembic downgrade -1

# Format code
format:
	@echo "ğŸ¨ Formatting code with black..."
	.venv/bin/black app/

# Lint code
lint:
	@echo "ğŸ” Running linting checks..."
	.venv/bin/flake8 app/
	.venv/bin/mypy app/

# Clean generated files
clean:
	@echo "ğŸ§¹ Cleaning up..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete
	@echo "âœ… Cleanup complete!"

# Docker commands
docker-up:
	@echo "ğŸ³ Starting Docker containers..."
	docker-compose up -d
	@echo ""
	@echo "â³ Waiting for PostgreSQL to be ready..."
	@sleep 5
	@echo "âœ… Docker containers started!"
	@echo ""
	@echo "PostgreSQL: localhost:5432"
	@echo "Redis: localhost:6379"
	@echo ""
	@echo "Run 'make db-upgrade' if this is first time setup"

docker-down:
	@echo "ğŸ›‘ Stopping Docker containers..."
	docker-compose down
	@echo "âœ… Docker containers stopped!"

docker-status:
	@echo "ğŸ“Š Docker containers status:"
	@docker-compose ps
	@echo ""
	@echo "Database info:"
	@docker exec trackwise_postgres psql -U trackwise -d trackwise -c "SELECT 'Users in database:' as info, COUNT(*) as count FROM users;" 2>/dev/null || echo "Database not ready or tables not created"

docker-db:
	@echo "ğŸ” Connecting to Docker PostgreSQL..."
	@echo "Type '\q' to exit"
	@echo ""
	docker exec -it trackwise_postgres psql -U trackwise -d trackwise